<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

<source>
  @type forward
  @label @mainstream
  port 24224
  bind 0.0.0.0
  source_address_key "address"
</source>

<label @fluentstream>
  <match **>
    @type stdout
  </match>
</label>

<label @mainstream>
  <filter **>
    @type record_transformer
    enable_ruby
    <record>
   
      message ${record["log"]}
      scale_task ${tag.split('|')[0]}
      scale_job_type ${tag.split('|')[1]}
      scale_job_version ${tag.split('|')[2]}
      scale_job_id ${tag.split('|')[3]}
      scale_job_exe ${tag.split('|')[4]}
      scale_node ${record["address"]}
      stream ${record["source"]}
      scale_order_num ${time.strftime('%Y%m%d%H%M%S%s')}
    </record>
    remove_keys ["container_id"]
  </filter>
<match **>
  @type stdout
</match>
  <match **>
    @type elasticsearch
    hosts "#{ENV['ELASTICSEARCH_URLS']}"
    logstash_format true
  </match>
</label>
