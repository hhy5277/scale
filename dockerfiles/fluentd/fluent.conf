<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

<source>
  @type syslog
  @label @mainstream
  port 8000
  protocol_type tcp
  bind 0.0.0.0
  tag system
</source>

<label @mainstream>
  <filter **>
    @type record_transformer
    enable_ruby
    <record>

      #scale_job_e18affa5-8cf4-45c6-bec6-6c8cad1c7af9-0017_256x1_main|scale-hello


      tag_items ${record["ident"].split('|')}
      message ${record["message"]}
      scale_task ${record["ident"].split('|')[0].sub(%r{^docker/}, '')}
      scale_job_exe ${record["ident"].split('|')[0].sub(%r{^docker/}, '').sub(%r{_[^_]*$}, '')}
      scale_node ${record["host"]}
      stream ${priority == 3 ? 'stderr' : 'stdout'}
      job_type ${record["ident"].split('|')[1]}
      scale_order_num ${time.strftime('%Y%m%d%H%M%S.s%z')}
    </record>

  </filter>
<match **>
  @type stdout
</match>
  <match **>
    @type elasticsearch
    hosts "#{ENV['ELASTICSEARCH_URLS']}"
    logstash_format true
    logstash_prefix scalelogs
  </match>
</label>
